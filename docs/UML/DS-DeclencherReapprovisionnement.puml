@startuml
actor Utilisateur
participant "NGINX"
participant "API Gateway"
participant "SagaController"
participant "SagaService"
participant "EventPublisher"

participant "ProduitController"
participant "ProduitService"

participant "MagasinController"
participant "MagasinService"

participant "LogistiqueController"
participant "LogistiqueService"

Utilisateur -> NGINX : POST /demande-reapprovisionnement
NGINX -> "API Gateway" : routage vers orchestrateur
"API Gateway" -> SagaController : POST /orchestration/demande
activate SagaController

SagaController -> SagaService : executeSaga(context)
activate SagaService

SagaService -> EventPublisher : publishEvent("SAGA_STARTED")

' Appel au microservice Produit
SagaService -> ProduitController : GET /api/v2/produits/1
activate ProduitController
ProduitController -> ProduitService : getProduit(1)
activate ProduitService
ProduitService --> ProduitController : produit trouvé
deactivate ProduitService
ProduitController --> SagaService : 200 OK
deactivate ProduitController
SagaService -> EventPublisher : publishEvent("PRODUCT_SUCCESS")

' Appel au microservice Magasin
SagaService -> MagasinController : GET /api/v2/magasins/1
activate MagasinController
MagasinController -> MagasinService : getMagasin(1)
activate MagasinService
MagasinService --> MagasinController : magasin trouvé
deactivate MagasinService
MagasinController --> SagaService : 200 OK
deactivate MagasinController
SagaService -> EventPublisher : publishEvent("STORE_SUCCESS")

' Appel au microservice Logistique
SagaService -> LogistiqueController : GET /api/v2/logistique/stockProduit/1/20
activate LogistiqueController
LogistiqueController -> LogistiqueService : verifierStock(1, 20)
activate LogistiqueService
LogistiqueService --> LogistiqueController : stock suffisant
deactivate LogistiqueService
LogistiqueController --> SagaService : 200 OK
deactivate LogistiqueController
SagaService -> EventPublisher : publishEvent("LOGISTIQUE_SUCCESS")

SagaService -> EventPublisher : publishEvent("SAGA_SUCCESS")
deactivate SagaService
SagaController --> "API Gateway" : 200 OK
deactivate SagaController
"API Gateway" --> Utilisateur : réponse JSON
@enduml
